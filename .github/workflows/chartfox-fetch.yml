steps:
  - name: Checkout repo
    uses: actions/checkout@v4
    with:
      fetch-depth: 0
      persist-credentials: true

  - name: Get ChartFox access token
    id: get_token
    env:
      CLIENT_ID: ${{ secrets.CHARTFOX_CLIENT_ID }}
      CLIENT_SECRET: ${{ secrets.CHARTFOX_CLIENT_SECRET }}
    run: |
      echo "üîê Getting ChartFox access token‚Ä¶"
      TOKEN_RESPONSE=$(curl -s -X POST https://auth.chartfox.org/oauth/token \
        -H "Content-Type: application/x-www-form-urlencoded" \
        -d "grant_type=client_credentials" \
        -d "client_id=${CLIENT_ID}" \
        -d "client_secret=${CLIENT_SECRET}")
      echo "Token response: $TOKEN_RESPONSE"
      ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.access_token')
      if [ "$ACCESS_TOKEN" == "null" ] || [ -z "$ACCESS_TOKEN" ]; then
        echo "‚ùå Failed to get access token."
        exit 1
      fi
      echo "‚úÖ Access token retrieved"
      echo "access_token=$ACCESS_TOKEN" >> $GITHUB_OUTPUT

  - name: Fetch charts from ChartFox API
    env:
      TOKEN: ${{ steps.get_token.outputs.access_token }}
      ICAO: ${{ github.event.inputs.icao }}
    run: |
      echo "üì° Fetching charts for $ICAO‚Ä¶"
      mkdir -p charts
      curl -s -X GET "https://api.chartfox.org/v2/airports/${ICAO}/charts/grouped" \
        -H "Authorization: Bearer ${TOKEN}" \
        -H "Accept: application/json" \
        -o charts/${ICAO}.json || (echo "‚ùå curl failed with status $?"; exit 1)
      echo "‚úÖ JSON saved to charts/${ICAO}.json"

  - name: Validate JSON exists
    run: |
      if [ ! -s charts/${{ github.event.inputs.icao }}.json ]; then
        echo "‚ùå Empty or missing JSON file."
        exit 1
      fi
      head -20 charts/${{ github.event.inputs.icao }}.json

  - name: Commit & push JSON
    env:
      ICAO: ${{ github.event.inputs.icao }}
    run: |
      git config user.name "github-actions"
      git config user.email "github-actions@github.com"
      git add "charts/${ICAO}.json"
      git diff --cached --quiet || git commit -m "üì¶ Add charts for ${ICAO}"
      git push
